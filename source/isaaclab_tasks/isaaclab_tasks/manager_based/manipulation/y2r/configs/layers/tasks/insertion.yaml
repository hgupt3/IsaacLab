# ==============================================================================
# Insertion Task Layer - Nut/Bolt Assembly
# ==============================================================================
# Task definition only - no play/mode settings.
# Phase 1: Grasp nut from above, hover over fixed bolt (basic setup).
# Uses push-T infrastructure: nut=object, bolt=outline (kinematic + contacts).
# ==============================================================================

trajectory:
  segments:
    - name: "grasp"
      type: "waypoint"
      pose: null              # Computed: start_poses
      duration: 2.5

    - name: "hover_high"
      type: "waypoint"
      # First hover position: higher above bolt
      pose: [-0.65, 0.0, 0.41, 1.0, 0.0, 0.0, 0.0]
      duration: 5.0

    - name: "hover_low"
      type: "waypoint"
      # First hover position: higher above bolt
      pose: [-0.65, 0.0, 0.36, 1.0, 0.0, 0.0, 0.0]
      duration: 2.0

    - name: "insert"
      type: "waypoint"
      # Second hover position: closer to bolt, ready for threading
      pose: [-0.65, 0.0, 0.325, 1.0, 0.0, 0.0, 0.0]
      duration: 7.0

    - name: "thread"
      type: "helical"
      axis: [0, 0, -1]           # Rotate around Z-axis (vertical)
      rotation: 18.85           # 3 full rotations (2π * 3 ≈ 18.85 radians)
      translation: [0, 0, -0.015]  # Descend 7.5cm onto bolt
      duration: 30.0
      hand_coupling: "position_only"  # Palm descends with nut, wrist orientation FROZEN
      # hand_orientation: null will use orientation from previous segment (hover_low)

    - name: "release"
      type: "waypoint"
      pose: [-0.65, 0.0, 0.31, 1.0, 0.0, 0.0, 0.0]              # Object stays at threaded position
      duration: 2.0
      hand_coupling: "none"   # Hand decouples and retreats

hand_trajectory:
  enabled: true
  grasp_sampling:
    fixed_origin_offset: [0.0, -0.025, 0]
    fixed_direction: [0, 0, 1]  # Grasp from above
    fixed_hand_roll: 0.0
    standoff_range: [0.03, 0.06]
    approach_distance: 0.15
    align_fraction: 0.7
  keypoints:
    count: [0, 0]               # No keypoints for threading task

# Use push-T config for nut/bolt setup
push_t:
  enabled: true
  object_usd: "assets/nut/nut.usd"       # Nut = object (manipulated)
  outline_usd: "{ISAACLAB_NUCLEUS_DIR}/Factory/factory_bolt_m16.usd"     # Bolt = outline (fixed target)
  object_scale: 2.5                                      # 2.5x scaled (M16: 2mm pitch → 5mm/rotation)
  outline_position: [-0.65, 0.0]                         # Bolt fixed position on table
  object_rotation: [1.0, 0.0, 0.0, 0.0]                  # Nut orientation (identity)
  outline_rotation: [1.0, 0.0, 0.0, 0.0]                 # Bolt orientation (identity)
  outline_has_contacts: true      # Enable collisions on bolt
  outline_is_kinematic: true      # Bolt is fixed/unmovable
  outline_has_gravity: false      # No gravity on bolt

  rolling_window: 3.0
  min_speed: 0.04
  min_angular_velocity: 0.8

goal:
  x_range: [-0.65, -0.65]
  y_range: [0.0, 0.0]

randomization:
  object:
    scale: [2.5, 2.5]           # Fixed scale for nut
    mass_scale: [0.08, 0.08]
    static_friction: [1.0, 1.0]
    dynamic_friction: [1.0, 1.0]
  reset:
    object_x: [0.05, 0.1]       # Nut spawns with X randomization
    object_y: [0.1, 0.2]     # Nut spawns with Y randomization
    object_yaw: [0.0, 0.0]     # Full rotation randomization

terminations:
  trajectory_deviation:
    position_threshold: [1.0, 1.0]     # Generous thresholds for Phase 1
    rotation_threshold: [3.0, 3.0]

  hand_pose_deviation:
    position_threshold: [0.25, 0.25]        # meters (lenient → strict)
    rotation_threshold: [2.5, 2.5]          # radians ~180° → ~180°

procedural_objects:
  generation:
    num_shapes: 0  